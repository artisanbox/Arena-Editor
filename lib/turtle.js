"use strict";var _createClass=function(){function e(t,i){for(var n=0;n<i.length;n++){var e=i[n];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var Turtle=function(){function e(t){_classCallCheck(this,e),this.canvas=t,this.context=this.canvas.getContext("2d"),this.commands=new CommandManager,this.position=new Position(this.canvas.width/2,this.canvas.height/2),this.nextPosition=this.position.copy(),this.nextAngle=this.angle=0,this.nextVisibility=this.visibility=!0,this.delay=200,this.pen=new Pen,this.drawList=[];var i=this.canvas.width/2,n=this.canvas.height/2;this.offsetX=i,this.offsetY=n,this.animate()}return _createClass(e,[{key:"animate",value:function(){var t=this;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var i=!0,n=!1,e=void 0;try{for(var s,o=this.drawList[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){s.value.draw(this.context)}}catch(t){n=!0,e=t}finally{try{!i&&o.return&&o.return()}finally{if(n)throw e}}this.drawTurtle(),this.commands.executeCommand(),requestAnimationFrame(function(){t.animate()})}},{key:"drawTurtle",value:function(){this.visibility&&(this.context.save(),this.context.beginPath(),this.context.fillStyle="#000",this.context.translate(this.position.x,this.position.y),this.context.rotate(this.angle*Math.PI/180),this.context.moveTo(0,0),this.context.lineTo(-10,5),this.context.lineTo(-10,-5),this.context.fill(),this.context.restore())}},{key:"setDelay",value:function(t){var i=0<arguments.length&&void 0!==t?t:500;this.delay=i}},{key:"setPenSize",value:function(t){this.pen.setSize(t)}},{key:"setPenColor",value:function(t){this.pen.setColor(t)}},{key:"penup",value:function(){this.pen.penup()}},{key:"pendown",value:function(){this.pen.pendown()}},{key:"hide",value:function(){this.visible(!1)}},{key:"show",value:function(){this.visible(!0)}},{key:"visible",value:function(t){var i=this;if(this.nextVisibility!==t){var n={visibility:this.nextVisibility=t};this.commands.undoList.push([VisibleState,n]),this.commands.add(new Command(function(){i.visibility=t,i.commands.next()}))}}},{key:"forward",value:function(t){var i=Math.cos(this.nextAngle*Math.PI/180)*t,n=Math.sin(this.nextAngle*Math.PI/180)*t;this.__goto(this.nextPosition.x+i,this.nextPosition.y+n)}},{key:"backward",value:function(t){this.forward(-t)}},{key:"goto",value:function(t,i){var o=this,a=this.nextPosition.copy(),h=this.delay,c=this.pen.copy();this.nextPosition.x=t+this.offsetX,this.nextPosition.y=i+this.offsetY;var l=this.nextPosition.copy(),n={nextPosition:l.copy(),forward:a.copy(),pen:c};this.commands.undoList.push([GoState,n]),this.commands.add(new Command(function(t,i){var n=i-t,e=l.x-a.x,s=l.y-a.y;new Line(c,a,o.position).draw(o.context),n<h?(o.position.x=a.x+n/h*e,o.position.y=a.y+n/h*s):(o.drawList.push(new Line(c,a,l)),o.position.x=l.x,o.position.y=l.y,o.commands.next())}))}},{key:"__goto",value:function(t,i){var o=this,a=this.nextPosition.copy(),h=this.delay,c=this.pen.copy();this.nextPosition.x=t,this.nextPosition.y=i;var l=this.nextPosition.copy(),n={nextPosition:l.copy(),forward:a.copy(),pen:c};this.commands.undoList.push([GoState,n]),this.commands.add(new Command(function(t,i){var n=i-t,e=l.x-a.x,s=l.y-a.y;new Line(c,a,o.position).draw(o.context),n<h?(o.position.x=a.x+n/h*e,o.position.y=a.y+n/h*s):(o.drawList.push(new Line(c,a,l)),o.position.x=l.x,o.position.y=l.y,o.commands.next())}))}},{key:"left",value:function(e){var s=this,o=this.nextAngle,a=this.delay;this.nextAngle-=e;var t={nextAngle:this.nextAngle,angle:-e};this.commands.undoList.push([RotateState,t]),this.commands.add(new Command(function(t,i){var n=i-t;s.angle=o,n<a?s.angle-=n/a*e:(s.angle-=e,s.commands.next())}))}},{key:"right",value:function(t){this.left(-t)}},{key:"towards",value:function(t,i){t+=this.offsetX,i+=this.offsetY;var n=t-this.nextPosition.x,e=i-this.nextPosition.y;return-180*Math.atan2(e,n)/Math.PI}},{key:"setHeading",value:function(t){this.left(t+this.nextAngle)}},{key:"heading",value:function(){return this.nextAngle}},{key:"position",value:function(){return this.nextPosition.copy()}},{key:"_undoRotate",value:function(e){var s=this,o=this.delay;this.nextAngle=e.nextAngle-e.angle,this.commands.add(new Command(function(t,i){var n=i-t;s.angle=e.nextAngle,n<o?s.angle-=n/o*e.angle:(s.angle-=e.angle,s.commands.next())}))}},{key:"_undoGo",value:function(o){var a=this,h=o.nextPosition.copy(),c=this.delay;o.nextPosition=o.forward.copy(),this.nextPosition=o.nextPosition.copy(),this.commands.add(new Command(function(){o.pen.isDown()&&a.drawList.pop(),a.commands.next()})),this.commands.add(new Command(function(t,i){var n=i-t,e=o.nextPosition.x-h.x,s=o.nextPosition.y-h.y;new Line(o.pen,o.nextPosition,a.position).draw(a.context),n<c?(a.position.x=h.x+n/c*e,a.position.y=h.y+n/c*s):(a.position.x=o.nextPosition.x,a.position.y=o.nextPosition.y,a.commands.next())}))}},{key:"_undoVisible",value:function(t){var i=this;this.commands.add(new Command(function(){i.visibility=!t.visibility,i.commands.next()}))}},{key:"undo",value:function(){this.commands.undo(this)}}]),e}(),GoState=function(){function i(t){_classCallCheck(this,i),this.turtle=t}return _createClass(i,[{key:"action",value:function(t){this.turtle._undoGo(t)}}]),i}(),RotateState=function(){function i(t){_classCallCheck(this,i),this.turtle=t}return _createClass(i,[{key:"action",value:function(t){this.turtle._undoRotate(t)}}]),i}(),VisibleState=function(){function i(t){_classCallCheck(this,i),this.turtle=t}return _createClass(i,[{key:"action",value:function(t){this.turtle._undoVisible(t)}}]),i}(),Pen=function(){function t(){_classCallCheck(this,t),this.lineSize=1,this.color="#000",this.isDrawing=!0}return _createClass(t,[{key:"setSize",value:function(t){this.lineSize=t}},{key:"setColor",value:function(t){this.color=t}},{key:"isDown",value:function(){return this.isDrawing}},{key:"pendown",value:function(){this.isDrawing=!0}},{key:"penup",value:function(){this.isDrawing=!1}},{key:"copy",value:function(){return Object.assign(Object.create(this),this)}}]),t}(),Line=function(){function e(t,i,n){_classCallCheck(this,e),this.pen=t,this.start=i,this.end=n}return _createClass(e,[{key:"draw",value:function(t){this.pen.isDown()&&(t.beginPath(),t.lineCap="round",t.lineWidth=this.pen.lineSize,t.strokeStyle=this.pen.color,t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.stroke())}}]),e}(),Position=function(){function n(t,i){_classCallCheck(this,n),this.x=t,this.y=i}return _createClass(n,[{key:"copy",value:function(){return new n(this.x,this.y)}}]),n}(),CommandManager=function(){function t(){_classCallCheck(this,t),this.history=[],this.undoList=[]}return _createClass(t,[{key:"add",value:function(t){this.history.push(t)}},{key:"next",value:function(){this.history.shift()}},{key:"executeCommand",value:function(){this.history.length&&this.history[0].execute((new Date).getTime())}},{key:"undo",value:function(t){if(this.undoList.length){var i=this.undoList.pop();new i[0](t).action(i[1])}}}]),t}(),Command=function(){function i(t){_classCallCheck(this,i),this.action=t,this.start=null}return _createClass(i,[{key:"execute",value:function(t){this.start||(this.start=(new Date).getTime()),this.action(this.start,t)}}]),i}();